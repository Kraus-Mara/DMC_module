Le module DMC (Demande de Moyens Chantiers) doit formaliser l’ensemble du cycle de vie d’une demande de matériel dans le cadre d’un projet chantier. La logique repose sur une création initiale de demande par projet, une phase de validation permettant la réservation du stock, une expédition vers le chantier, un retour imposant un inventaire sans affichage des quantités attendues, puis une réintégration dans le stock disponible, avec possibilité de déroger au flux normal dans le cas d’un transfert direct entre deux chantiers. Le module doit donc s’intégrer de manière cohérente avec les mécanismes internes d’ERPNext : réservations, stock ledger entries, stock reservations entries (si version récente), Stock Entry, ajustements d’écart et gestion multi-entrepôts.

La demande DMC constitue l’objet central. À la création, elle doit simplement enregistrer le projet, les dates et les articles sollicités sans déclencher aucun mouvement de stock ni aucune réservation. Ce n’est qu’au moment de la validation que le système doit générer les réservations. Cette étape doit créer, pour chaque ligne d’article, une réservation dans le système natif : soit via Stock Reservation Entry si la version ERPNext le supporte, soit en simulant un mécanisme équivalent par la modification des champs reserved_qty dans les bins — mais cette seconde solution est déconseillée car elle modifie directement la logique interne du stock. L’objectif de cette validation est que les quantités demandées ne puissent plus être allouées à d’autres demandes ou documents de vente. La DMC passe alors en état “matériel réservé” et devient bloquante vis-à-vis des autres processus.

L’expédition doit se faire exclusivement via un Stock Entry de type Material Issue. Le déclencheur sera un bouton dans la DMC permettant de générer automatiquement un document prérempli transférant les quantités réservées depuis l’entrepôt source vers un entrepôt logique représentant le chantier. Ce dernier peut être un "Project Warehouse" (une pratique courante pour le matériel temporaire, innée dans ERPNext). Au moment où l’expédition est soumise, la réservation doit être levée, car le stock n’est plus théorique : il est physiquement sorti de l’entrepôt et porté sur le chantier. Durant toute la durée du chantier, les articles concernés doivent être considérés comme indisponibles pour l’ensemble du reste du système.

Le retour de chantier doit obligatoirement passer par un inventaire masqué. ERPNext n’a pas de mécanique native de “blind inventory”, mais il est possible de la reproduire en créant un doctype de retour associé à la DMC, dans lequel les quantités attendues ne sont jamais rendues visibles. Les seules valeurs autorisées pour l’utilisateur sont les quantités réellement comptées. Le stock retourné ne doit jamais être réintégré directement dans l’entrepôt principal. Il doit d’abord être placé automatiquement dans un entrepôt tampon dédié, par exemple “Chantier X – Retour”, via un nouveau Stock Entry de type Material Transfer. Tant que l’inventaire retour n’a pas été validé par un responsable matériel, ce stock dans le tampon doit être marqué comme indisponible. En pratique, cela peut être assuré en configurant l’entrepôt tampon comme unavailable ou en empêchant tout autre document de l’utiliser via des restrictions de permission. La validation de l’inventaire retour doit provoquer une réintégration finale vers l’entrepôt de base ainsi que la création d’un ajustement d’inventaire en cas d’écart. Les quantités manquantes ou excédentaires doivent être enregistrées comme telles dans un doctype de log prévu pour le suivi des pertes, vols ou erreurs de chantier.

___________________

Une situation exceptionnelle doit être envisagée : le transfert direct d’un chantier à un autre. Dans ce cas, le flux standard retour → inventaire → réintégration → réissue ne doit pas être appliqué. On doit permettre la génération d’un Stock Entry de type Material Transfer entre les deux entrepôts chantiers. Ce mouvement ne doit pas rendre le matériel disponible dans la période intermédiaire, ni entraîner une remise à zéro de l’état de la DMC initiatrice. Simplement, la traçabilité doit montrer que certains articles ont quitté un chantier pour un autre sans repasser par les entrepôts centraux.

___________________

Sur le plan technique, le module devra définir le doctype DMC ainsi que sa table enfant pour les articles. Il devra incorporer un champ statut reflétant les différentes étapes du processus : brouillon, en attente de validation, matériel réservé, expédié, retour en inventaire, clôturé. Les transitions doivent être gérées via un workflow interne ERPNext. Côté backend, les opérations de stock devront être implémentées dans les hooks Python de la DMC : validate, on_submit, before_submit ou via des méthodes explicites appelées par des boutons. Le masquage des quantités attendues lors de l’inventaire retour devra être assuré côté client dans le script JS, en modifiant dynamiquement les propriétés de champs pour empêcher toute divulgation. Enfin, les Stock Entry devront toujours être générés via l’API document interne de Frappe afin de respecter le stock ledger.
